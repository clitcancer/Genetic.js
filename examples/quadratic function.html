<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Quadratic function</title>
    <script src="../Genetic.js"></script>
    <style>
        input {
            width: 30px;
        }
    </style>
</head>

<body>
    Description:
    <br> The genetic algorithm tries to find a, b, and c knowing the 2 roots of that function.
    <br>
    <br>the formula:
    <br> f(x) = ax
    <sup>2</sup> + bx + c
    <br>
    <br>Roots:
    <br> f(
    <input id="x1" value="-1" />) = 0
    <br> f(
    <input id="x2" value="3" />) = 0
    <br>
    <button id="restart">restart with new roots</button>

    <br>
    <br> best guess:
    <br> a =
    <span id="a"></span>
    <br> b =
    <span id="b"></span>
    <br> c =
    <span id="c"></span>
    <br> How far off the answer:
    <span id="accuracy"></span>

    <script>
        function createPopulation(genes) {
            let temp = []

            for (let i = 0; i < ENV.membersPerPopulation; i++) {
                temp.push(new Guess(genes ? genes[i] : null))
            }

            return temp
        }
        class Guess {
            constructor(dna) {
                this.fitness = 0
                this.dna = dna || {
                    a: Math.random() * 10,
                    b: Math.random() * 10,
                    c: Math.random() * 10
                }
            }

            calcFitness(x) {
                this.fitness += Math.abs(this.dna.a * x ** 2 + this.dna.b * x + this.dna.c)
            }
        }

        // settings
        const ENV = {
            membersPerPopulation: 100
        }

        // restart button
        document.querySelector('#restart').addEventListener('click', () => {
            clearInterval(interval)
            x = [1, 2].map(e => Number(document.querySelector(`#x${e}`).value))
            pop = createPopulation()
            interval = setInterval(newGen, 10)
        })

        // catch the DOM
        let answers = {};
        ['a', 'b', 'c'].forEach(e => answers[e] = document.querySelector(`#${e}`))
        answers.accuracy = document.querySelector(`#accuracy`)

        let x = [1, 2].map(e => Number(document.querySelector(`#x${e}`).value))

        // create population
        let pop = createPopulation()

        let interval = setInterval(newGen, 10)

        function newGen() {

            // calculate fitness
            for (const mem of pop) {
                mem.calcFitness(x[0])
                mem.calcFitness(x[1])
                mem.fitness = 1 / mem.fitness
            }

            // now lets find the parents
            let g = new Genetic(.1, 2, {
                inheritance: 'chromosome',
                mating: 'best'
            })
            let parents = g.findParents(pop)

            // lets display the best guess
            for (const key in answers) {
                if (answers.hasOwnProperty(key) && key != 'accuracy') {
                    answers[key].innerText = parents[1][key].toFixed(4)
                }
            }
            // calc accuracy
            let sum = 0
            sum = Math.abs(parents[1].a * x[0] ** 2 + parents[1].b * x[0] + parents[1].c)
            sum += Math.abs(parents[1].a * x[1] ** 2 + parents[1].b * x[1] + parents[1].c)
            answers.accuracy.innerText = sum

            // now we'll create a new population
            g.createGenes(ENV.membersPerPopulation)
            g.mutateGenes(
                Genetic.mutateSome(
                    Genetic.add(-0.5, 0.5)
                )
            )
            pop = createPopulation(g.newGenes)
        }
    </script>
</body>

</html>
